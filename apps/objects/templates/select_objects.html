{% extends 'base.html' %}
{% load bootstrap main_filters dajaxice_templatetags staticfiles jsonify %}

{% block subtitle %}Select Objects{% endblock %}

{% block forestyle %}
<link href="{{ STATIC_URL }}css/select2.css" rel="stylesheet"/>
<!-- <link rel="stylesheet" href="{{ STATIC_URL }}css/jquery-ui-1.10.2.custom.min.css" /> -->
<link rel="stylesheet" href="{{ STATIC_URL }}css/jquery-ui-1.10.2.custom.min.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/jquery.ui.theme.css" />
{% endblock %}

{% block forejs %} 
 {% endblock %}

{% block content_title %}
    <h1>Select Objects</h1>
{% endblock %}

{% block main %}
<div class="relative">
    <div class="row saved-query-block">
        <div class="span4">
            <a class="btn dropdown-toggle" id="js_queries_list_btn">Saved query<span class="caret"></span></a>
            <table class="table table-bordered js_queries_list saved-query-list" style="display: none">
                <tbody class="js_query_list">
                    {% for query in saved_query_list %}
                        {% include "saved_query_components.html" %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <form method="post" action="./#result" id="js_id_form" class="form-horizontal js-active-form span12 pull-left">
            {% csrf_token %}
            {% for error in form.non_field_errors %}
                <div class="alert alert-error">
                    <a data-dismiss="alert" class="close">×</a>
                    <p>{{ error }}</p>
                </div>
            {% endfor %}
            
            {% for field in form.hidden_fields %}
                {{ field }}
            {% endfor %}

            {% for error in form.non_field_errors %}
                <div class="alert alert-error">
                    <a data-dismiss="alert" class="close">×</a>
                    <p>{{ error }}</p>
                </div>
            {% endfor %}

            {# <!-- Organism --> #}
            <div class="control-group {% if form.organism.errors %}error{% endif %}">
                <label class="control-label" for="{{ form.organism.id_for_label }}">{{ form.organism.label }} <i class="red">*</i></label>
                <div class="controls" id="js_organism_container">
                    {{ form.organism }}
                    {% for error in form.organism.errors %}
                        <span class="help-inline">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>

            {# <!-- display_fields --> #}
            <div class="control-group {% if form.display_fields.errors %}error{% endif %}">
                <label class="control-label">{{ form.display_fields.label }}</label>
                <div class="controls list-inline">
                    {{ form.display_fields }}
                    {% for error in form.display_fields.errors %}
                        <span class="help-inline">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>

            {# <!-- attributes_list --> #}
            <div class="control-group {% if form.attributes_list.errors %}error{% endif %}" id="js_attribute_container">
                <label class="control-label" for="{{ form.attributes_list.id_for_label }}">{{ form.attributes_list.label }}</label>
                <div class="controls">
                    {{ form.attributes_list }}
                    {% for error in form.attributes_list.errors %}
                        <span class="help-inline">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>

        {# <!-- Filters --> #}
            <fieldset id="js_filters_block">
                <legend>Filters</legend>
                {% if query_history %}
                    <ul class="breadcrumb">
                        {% for step in query_history %}
                            <li>
                                <a data-toggle="tooltip" class="js_query_history_step" data-placement="bottom" title="{{ step }}" data-original-title="{{ step }}">
                                    Query {{ forloop.counter }}
                                </a> <span class="divider">></span></li>
                        {% endfor %}
                        <li class="active">This query</li>
                    </ul>
                {% endif %}
                <!-- <div class="control-group">
                    <div class="controls"> -->
                {% if row_query_str %}
                    <div class="where-search">
                        <!-- <label for="id_new_query" class="checkbox inline">
                            <input id="id_new_query" class="js_where_search" name="search_in_results" type="radio" value="new_query" checked="checked"> New query
                        </label> -->
                        <label for="id_change_current_query" class="checkbox inline">
                            <input id="id_change_current_query" class="js_where_search" name="where_search" 
                                type="radio" value="change_current_query" checked="checked"> Change current query
                        </label>
                        <label for="id_search_in_results" class="checkbox inline">
                            <input id="id_search_in_results" class="js_where_search" name="where_search" type="radio" value="search_in_results"> Search in results
                        </label>
                    </div>
                {% endif %}
                   <!--  </div>
                </div> -->
                
                <div class="row js_new_query actual_filters">
                    <div  class="filters_block offset1 span8">
                        <!-- <div class="row control-group">
                            <div class="offset2 span4"> -->
                        <div class="operand-block-wraper">
                            <div class="btn-group operand-block js_operand_block">
                                <input type="radio" name="select_operand" id="operand_ALL" class="js_select_operand" value="ALL" {% if logic_operation == "ALL" or not logic_operation %}checked="checked"{% endif %}>
                                <label class='btn btn-info' for="operand_ALL">ALL</label>
                                <input type="radio" name="select_operand" id="operand_ANY" class="js_select_operand" value="ANY" {% if logic_operation == "ANY" %}checked="checked"{% endif %}>
                                <label class='btn btn-info' for="operand_ANY">ANY</label>
                                <input type="radio" name="select_operand" id="operand_NONE" class="js_select_operand" value="NONE" {% if logic_operation == "NONE" %}checked{% endif %}>
                                <label class='btn btn-info' for="operand_NONE">NO ONE</label>  
                            </div>
                        </div>
                            <!-- </div>
                        </div> -->

                        <div class="row">
                            <div class="span8">
                                <table class="table js_query_table">
                                  <tbody>
                                    {% for pk, filter in field_filters_dict.items %}
                                        <tr class="js_query_tr" data-pk="{% firstof pk '0' %}">
                                            <td>
                                                <select style="width:300px" class="js_query_field js_query">
                                                    <optgroup label="Fields">
                                                        <!-- <option value="name" data-atype="string">name</option> -->
                                                        {% for field, atype in fields_with_type %}
                                                            <option value="{{ field }}" data-atype="{{ atype }}" {% if filter.0 == field %}selected{% endif %}>{{ field }}</option>
                                                        {% endfor %}
                                                    </optgroup>
                                                    <optgroup label="Attributes" class="js_query_attr_list">
                                                        {% for id, attr, atype in attributes_from_organism %}
                                                            <option value="attr.{{ id }}" data-atype="{{ atype }}" {% if filter.0 == "attr."|add:attr %}selected{% endif %}>{{ attr }}</option>
                                                        {% endfor %}
                                                    </optgroup>
                                                </select>
                                                <!-- <div class="btn-group"> -->
                                                <select name="query_field" style="width: 80px;" class="js_query_operation js_query">
                                                    {% if filter.3 == 'integer' or filter.3 == 'float' %}
                                                        <option value="=" {% if filter.1 == '=' %}selected{% endif %}>=</option>
                                                        <option value="!=" {% if filter.1 == '!=' %}selected{% endif %}>&ne;</option>
                                                        <option value=">=" {% if filter.1 == '>=' %}selected{% endif %}>&ge;</option>
                                                        <option value="<=" {% if filter.1 == '<=' %}selected{% endif %}>&le;</option>
                                                        <option value=">" {% if filter.1 == '>' %}selected{% endif %}>&gt;</option>
                                                        <option value="<" {% if filter.1 == '<' %}selected{% endif %}>&lt;</option>
                                                    {% else %}
                                                        <option value="=" {% if filter.1 == '=' %}selected{% endif %}>=</option>
                                                        <option value="!=" {% if filter.1 == '!=' %}selected{% endif %}>&ne;</option>
                                                        <!-- <option value="in">IN</option> -->
                                                    {% endif %}
                                                    
                                                </select>

                                                <!-- </div> -->
                                                <input class="span2 js_query_value js_query" type="text" value="{% firstof filter.2 %}">
                                            </td>
                                            <td>
                                                <a class="btn btn-danger js_del_query_item" {% if not filter.2 %}style="display: none;"{% endif %}>x</a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    <tr>
                                        <td></td>
                                        <td>
                                            <a class="btn btn-success js_add_query_item">+</a>
                                        </td>
                                        
                                    </tr>
                                  </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row js_search_in_results" style="display: none">
                    {% include "object_filter_component.html" %}
                </div>

            </fieldset>
        {# <!-- End Filters --> #}
            <div class="control-group {% if form.attributes_list.errors %}error{% endif %}">
                <label class="control-label" for="js_row_query">Row Query</label>
                <div class="controls">
                    <input class="input-xxlarge" name="row_query_str" id="js_row_query" type="text" value="{{ row_query_str }}">
                    <input class="hidden" name="field_filters_dict" id="js_field_filters_dict" type="text">
                    <input class="hidden" name="query_history" id="js_query_history" type="text">
                    <input class="hidden" name="query_history_step" id="js_query_history_step_result" type="text">
                </div>
            </div>
            

            <div class="form-actions form-inline">
                <input type="text" id="save_query_name" placeholder="Type query name">
                <a href="#js_queries_list_btn" class="btn btn-success" onclick="save_query();">Save query</a>&nbsp;
                <button type="submit" class="btn btn-primary">Run</button>&nbsp;
            </div>
        </form>
    </div>

    {% if object_list %}
    <div class="object_result_table" id="result">
        <div class="row">
            <div class="span12">

                <p>
                    Find {{ objects_count }} objects
                    <a class="btn pull-right" data-toggle="modal" data-target="#DownloadObjectSelection">Download this selection</a>
                </p>
                <div id="js_object_result_table">

                    {% include "object_list.html" %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- <div class="preloader-block" style="display: none"> -->
        <div class="preloader-img" style="display: none"></div>
    <!-- </div> -->

</div>

{# <!-- Hidden Components --> #}
    {#<!-- Reference query item. Hidden. -->#}
    <table style="display: none">
        <tbody>
            <tr id="js_reference_query_item">
                <td>
                    <select style="width:300px" class="js_query_field js_query">
                        <optgroup label="Fields">
                            <!-- <option value="name" data-atype="string">name</option> -->
                            {% for field, atype in fields_with_type %}
                                <option value="{{ field }}" data-atype="{{ atype }}">{{ field }}</option>
                            {% endfor %}
                        </optgroup>
                            <optgroup label="Attributes" class="js_query_attr_list">
                            {% for id, attr, atype in attributes_from_organism %}
                                <option value="attr.{{ id }}" data-atype="{{ atype }}">{{ attr }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                    <select name="query_field" style="width: 80px;" class="js_query_operation js_query">
                        <option value="=">=</option>
                        <option value="!=">&ne;</option>
                        <!-- <option value="in">IN</option> -->
                    </select>

                    <input class="span2 js_query_value js_query" type="text">
                </td>
                <td>
                    <a class="btn btn-danger js_del_query_item">x</a>
                </td>
            </tr>
        </tbody>
    </table>
    {# <!-- --> #}
        
    
    <select name="query_field" style="display: none" class="js_option_for_type_string">
        <option value="=">=</option>
        <option value="!=">&ne;</option>
        <!-- <option value="in">IN</option> -->
    </select>
    <select name="query_field" style="display: none" class="js_option_for_type_integer">
        <option value="=">=</option>
        <option value="!=">&ne;</option>
        <option value="&gt;=">&ge;</option>
        <option value="&lt;=">&le;</option>
        <option value="&gt;">&gt;</option>
        <option value="&lt;">&lt;</option>
        <!-- <option value="in">IN</option> -->
    </select>
{# <!-- End Hidden Components --> #}

{% if object_download_form %}
    {# <!-- Modal Window --> #}
        <div id="create_modal_form">
            <div class="modal" id="DownloadObjectSelection" tabindex="-1" role="dialog"
                 aria-labelledby="ModalLabel" aria-hidden="true" style="display: none">
                 <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="ModalLabel">Download object selection</h3>
                </div>
                <div class="modal-body">
                    <form method="POST" id="download_object_selection" action="">
                        {% csrf_token %}
                        {{ object_download_form|bootstrap }}
                        <a class="btn btn-primary" onclick="download_objects();">Export</a>
                    </form>
                </div>
            </div>
        </div>
    {# <!-- --> #}
{% endif %}

{% endblock %}


{% block endjs %}

{% dajaxice_js_import %}
<script src="{{ STATIC_URL }}js/jquery-ui-1.10.2.custom.min.js"></script>
<!-- <script src="{{ STATIC_URL }}js/jquery-ui-1.9.2.custom.min.js"></script> -->
<script type="text/javascript" src='{% static "/static/dajax/jquery.dajax.core.js" %}'></script>
<!-- <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="{{ STATIC_URL }}js/bootstrap.min.js"></script> -->
<script src="{{ STATIC_URL }}js/select2.min.js"></script>


<script type="text/javascript">
    $('.js_query_tr .js_query_field').select2({});

    attribute_container = $('#js_attribute_container')
    filters_block = $('#js_filters_block')
    // preloader = $('.preloader-block')
    preloader_img = $('.preloader-img')
    prepand_query = ''
    old_query = '{{ old_row_query_str|safe }}'
    query_history_step_result = $('#js_query_history_step_result')
    // $('.preloader').hide();

    function download_objects(){
        Dajaxice.apps.bioface.download_objects(Dajax.process, { 
            'query_dict': JSON.stringify({{ query_dict_str }}),
            'form': $('#download_object_selection').serialize(true),
        });
    }

    function success_adding_download(){
        $('#DownloadObjectSelection').modal('hide');
    }

    function save_query() {
        var query_name = $('#save_query_name').val()
        if (query_name) {
            start_show_loading();
            Dajaxice.apps.objects.save_query(Dajax.process, {
                // 'data':JSON.stringify(data),
                'name': query_name,
                'form': $('#js_id_form').serialize(true),
                'field_filters_dict': field_filters_dict,
                'query_str': $('#js_row_query').val(),
            });
        } else {
            // TODO. create alert
        }
      return false;
    };

    function start_show_loading() {
        // preloader.show(); 
        preloader_img.show()}

    function stop_show_loading() {
        // preloader.hide(); 
        preloader_img.hide()}

    $('#js_attribute_container select').select2({
            maximumSelectionSize: 5,
            minimumInputLength: 0,
        });
    function create_attribute_select(){
        $('#js_attribute_container select').select2({
            maximumSelectionSize: 10,
            minimumInputLength: 0,
        });
        stop_show_loading();
        attribute_container.show();
        filters_block.show();
    };

    filter_item_html = $('#js_reference_query_item').html()

    function update_query_items(){
        filter_item_html = $('#js_reference_query_item').html()
        attr_options = $('#js_reference_query_item .js_query_attr_list').html()
        $('.actual_filters .js_query_attr_list').html(attr_options)
        $('.actual_filters .js_query_tr .js_query_field:last').select2({
                placeholder: "Select a Field or Attribute",
            });
    };

    function generate_row_query() {
        var query_list = [];
        for (var key in field_filters_dict) {
            var value_type = field_filters_dict[key][3]
            var prep_list = field_filters_dict[key].slice(0,3)
            if (value_type == 'integer' | value_type == 'float' | value_type == 'range') {
                // ToDo Validate
            } else {
                prep_list[2] = '"' + prep_list[2] + '"'
                // prep_list[2] = "'" + prep_list[2] + "'"
            };
            query_list = query_list.concat(prep_list.join(' '));
        }
        if (logic_operation == 'ANY') {
            var row_query = query_list.join(' OR ')
        } else {
            // ALL and NONE
            var row_query = query_list.join(' AND ')
        }
        if (logic_operation == 'NONE' && row_query) {
            row_query = '!(' + row_query + ')'
        }
        if (prepand_query) {
            if (row_query) {
                $('#js_row_query').val('('+prepand_query+') AND ' + row_query)
            } else {
                $('#js_row_query').val(prepand_query)
            }
        } else if (old_query) {
            $('#js_row_query').val(old_query + ' AND ' + row_query)
        } else {
            $('#js_row_query').val(row_query)
        }
        
    };

    function show_messages(){
        $('.extra-message-block').fadeIn().delay(4000).fadeOut();
    }

    // if ($('#id_organism option:selected').val()) {
    //     start_show_loading();
    //     create_attribute_select();
    // }
    // else {
    //     $('#js_attribute_container').hide();
    //     filters_block.hide();
    // };

    $(function() {

        field_filters_dict_old = {}
        field_filters_dict_new = {}
        {% for pk, filter in field_filters_dict.items %}
            {% if pk != '' %}
                field_filters_dict_old['{{ pk }}'] = ['{{filter.0}}', '{{filter.1}}', '{{filter.2}}', '{{filter.3}}']
                {% if forloop.last %} 
                    item_pk = {{ pk }} +1
                {% endif %}
            {% endif %}
        {% endfor %}
        field_filters_dict = field_filters_dict_old

        query_history_json = {{ query_history|jsonify }}


        $('.breadcrumb .js_operand_block').tooltip({
            show: {
                effect: "slideDown",
                delay: 30
            } 
        });

        $(".js_operand_block").buttonset();  

        // Saved queries list popup 
        $('#js_queries_list_btn').click(function(){
            $(this).next('.js_queries_list').slideToggle()
        })

        // Save query
        $('#save_query_name').keypress(function (e) {
            // if pressed Enter
            if (e.which == 13) {
                save_query();
                return false;
            }
        });

        // Delete saved query
        $('.js_query_list').delegate('.delete_query_item', 'click', function(){
            if (confirm("Нou agree to lose this query?")) {
                var query_name = $(this).data('name')
                // alert();
                // if (query_name) {

                // start_show_loading();
                Dajaxice.apps.objects.delete_saved_query(Dajax.process, {'name': query_name });
                // alert($(this).parents('.js_saved_queries_item').html());
                $(this).parents('.js_saved_queries_item').remove()

                // } else {

                // }
            }
        });

        // Organism trigger
        $('#id_organism').change(function(){
            if ($('#id_organism option:selected').val()) {
                start_show_loading();
                Dajaxice.apps.objects.update_attributes_from_organism(Dajax.process,{'organism_id': $(this).val()});
            } else {
                filters_block.hide();
                attribute_container.hide();
            }
        });


        logic_operation = '{% firstof logic_operation "ALL" %}'
        $('.js_new_query .js_select_operand').click(function(){
            new_query_logic_operation = $(this).val()
            logic_operation = new_query_logic_operation
            // $(this).next('#id_select_operand').val(logic_operation)
            generate_row_query();
        })

        $('.js_new_query .js_select_operand').click(function(){
            search_in_result_logic_operation = $(this).val()
            logic_operation = search_in_result_logic_operation
            // $(this).next('#id_select_operand').val(logic_operation)
            generate_row_query();
        })

        // Change available operation for select field
        $('.js_query_table').delegate('.js_query_field', 'change', function(){
            field_type = $(this).find('option:selected').data('atype')
            operation_select = $(this).next('.js_query_operation')
            if (field_type == 'integer' | field_type == 'float') {
                operation_select.html($('.js_option_for_type_integer').html())
            } else {
                operation_select.html($('.js_option_for_type_string').html())
            }
        });

        item_pk = 0
        // Add query item
        $('.js_query_table').delegate('.js_add_query_item', 'click', function(){
            item_pk++;
            $(this).parent().parent().before('<tr class="js_query_tr" data-pk="'+item_pk+'">'+filter_item_html+'</tr>')
            $('.actual_filters .js_query_tr .js_query_field:last').select2({
                placeholder: "Select a Field or Attribute",
            });
        });

        // Update query fields
        $('.js_query_table').delegate('.js_query', 'change', function(){
            var filter = $(this).parent().parent()
            var filter_value = filter.find('.js_query_value').val()
            
            if (filter_value) {
                filtered_field = filter.find('select.js_query_field')
                var filtered_field_val = filtered_field.val()
                var filtered_field_type = filtered_field.find('option:selected').data('atype')
                var filtered_operation = filter.find('.js_query_operation').val()
                var item_pk = filter.data('pk')
                field_filters_dict[item_pk] = [filtered_field_val, filtered_operation, filter_value, filtered_field_type]

                generate_row_query();
                // filter.find('.js_del_query_item').show()
            } else {
                // filter.find('.js_del_query_item').hide()
            }
        });

        // Remove query item
        $('.js_query_table').delegate('.js_del_query_item', 'click', function(){
            filter = $(this).parent().parent()
            if (filter.parent().find('.js_query_tr').length < 2) {
                filter.before('<tr class="js_query_tr" data-pk="'+item_pk+'">'+filter_item_html+'</tr>')
                $('.actual_filters .js_query_tr .js_query_field:first').select2();
            }
            delete field_filters_dict[filter.data('pk')]
            generate_row_query();

            filter.remove()
        });

        // Query trigger
        where_search = $('.js_where_search')
        search_in_results = $('.js_search_in_results')
        new_query = $('.js_new_query')

        function switch_where_search(){
            // switch ($('.js_where_search:checked').val())
            // {
            // case 'change_current_query':
            //   search_in_results.fadeOut(function(){
            //         search_in_results.removeClass('actual_filters');
            //         new_query.fadeIn().addClass('actual_filters');
            //         prepand_query = ''
            //         old_query = '{{ old_row_query_str|safe }}'
            //         field_filters_dict = field_filters_dict_old
            //         generate_row_query()
            //     });
            //   break;
            // case 'search_in_results':
            //     new_query.fadeOut(function(){
            //         new_query.removeClass('actual_filters');
            //         search_in_results.fadeIn().addClass('actual_filters');
            //         prepand_query = '{{ row_query_str|safe }}'
            //         old_query = '{{ old_row_query_str|safe }}'
            //         field_filters_dict = field_filters_dict_new
            //         generate_row_query()
            //     });
            //   break;
            // case 'new_query':
            //     search_in_results.fadeOut(function(){
            //         search_in_results.removeClass('actual_filters');
            //         new_query.fadeIn().addClass('actual_filters');
            //         prepand_query = ''
            //         old_query = ''
            //         field_filters_dict = field_filters_dict_old
            //         generate_row_query()
            //     });
            //   break;
            // }

            if ($('.js_where_search:checked').val() == 'change_current_query') {
                search_in_results.fadeOut(function(){
                    search_in_results.removeClass('actual_filters');
                    new_query.fadeIn().addClass('actual_filters');
                    prepand_query = ''
                    old_query = '{{ old_row_query_str|safe }}'
                    field_filters_dict = field_filters_dict_old
                    generate_row_query()
                });
            } else {
                new_query.fadeOut(function(){
                    new_query.removeClass('actual_filters');
                    search_in_results.fadeIn().addClass('actual_filters');
                    prepand_query = '{{ row_query_str|safe }}'
                    old_query = '{{ old_row_query_str|safe }}'
                    field_filters_dict = field_filters_dict_new
                    generate_row_query()
                });
            }
        }

        {% if query_history_step %} 
            where_search.attr('checked', false);
            $('.js_where_search:radio[value="search_in_results"]').attr('checked', true)
            switch_where_search(); 
        {% endif %}

        where_search.change(function(){
            switch_where_search()
        });
        
        // Load query from history
        $('.js_query_history_step').click(function(){
            query_history_step_result.val($(this).data("original-title"));
            $('#js_id_form').submit()
        })

        // Before form submit
        $('#js_id_form').submit(function(){
            start_show_loading();
            $('#js_field_filters_dict').val(JSON.stringify(field_filters_dict));
            $('#js_query_history').val(JSON.stringify(query_history_json));
        });
    });

</script>
{% endblock %}